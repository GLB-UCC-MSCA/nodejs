name: Build RPM file

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: 'Nodejs version'
        default: '22.14.0'
      release:
        type: string
        required: true
        description: 'Nodejs release'
        default: '0'

jobs:
  build_rpm_file:
    name: Build RPM file
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Build RPM file
        env:
          NODEJS_VERSION: ${{ github.event.inputs.version }}
          NODEJS_RELEASE: ${{ github.event.inputs.release }}
        run: |
          curl -L https://github.com/DE-MUC-UCC-OSEM/nodejs/releases/download/$NODEJS_VERSION-r$NODEJS_RELEASE/nodejs-$NODEJS_VERSION-r$NODEJS_RELEASE-x86_64.tar.xz -o ${{ github.workspace }}/nodejs-$NODEJS_VERSION-r$NODEJS_RELEASE-x86_64.tar.xz
          curl -L https://github.com/DE-MUC-UCC-OSEM/nodejs/releases/download/$NODEJS_VERSION-r$NODEJS_RELEASE/nodejs-$NODEJS_VERSION-r$NODEJS_RELEASE-aarch64.tar.xz -o ${{ github.workspace }}/nodejs-$NODEJS_VERSION-r$NODEJS_RELEASE-aarch64.tar.xz
          mkdir -p ${{ github.workspace }}/files
          tar --directory ${{ github.workspace }}/files -xvf ${{ github.workspace }}/nodejs-$NODEJS_VERSION-r$NODEJS_RELEASE-x86_64.tar.xz
          sed -i -e "s/__VERSION__/$NODEJS_VERSION/" ${{ github.workspace }}/nodejs-binary.spec
          sed -i -e "s/__RELEASE__/$NODEJS_RELEASE/" ${{ github.workspace }}/nodejs-binary.spec
          rpmbuild -bb --root "${{ github.workspace }}" --build-in-place --buildroot /files --define "_rpmdir ${{ github.workspace }}" ${{ github.workspace }}/nodejs-binary.spec
          GPG_TTY="" rpmsign --key-id=${{ secrets.GPG_KEY_ID }} --addsign ${{ github.workspace }}/x86_64/nodejs-binary-${{ github.event.inputs.version }}-${{ github.event.inputs.release }}.x86_64.rpm

      - name: update release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODEJS_VERSION: ${{ github.event.inputs.version }}
          NODEJS_RELEASE: ${{ github.event.inputs.release }}
        run: |
          gh release upload $NODEJS_VERSION-$NODEJS_RELEASE x86_64/nodejs-binary-$NODEJS_VERSION-$NODEJS_RELEASE.x86_64.rpm

      - name: Cleanup environment
        if: ${{ always() }}
        run: |
          echo "Cleaning up environment..."
          git clean -ffdx
